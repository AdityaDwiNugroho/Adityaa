<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Diary - Aditya Dwi Nugroho</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231a1a1a'/><text x='50' y='70' font-family='monospace' font-size='60' fill='%23d4af37' text-anchor='middle'>A</text></svg>">
    <link rel="stylesheet" href="/styles.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
    <div class="cursor-dot"></div>
    <div class="cursor-ring"></div>
    <div class="bg-animation"></div>
    <div class="scroll-progress"></div>
    
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <a href="/" style="color: var(--accent); text-decoration: none;">
                    <span class="pixel-text">ADN.exe</span>
                </a>
            </div>
            <ul class="nav-links">
                <li><a href="/">Back to Portfolio</a></li>
            </ul>
        </div>
    </nav>

    <section class="section-editorial" style="min-height: 100vh;">
        <div class="editorial-layout">
            <div class="section-header">
                <div class="section-number">00</div>
                <h1 class="section-title-editorial">Personal Diary</h1>
                <div class="section-line"></div>
                <p class="section-description">Thoughts, notes, and reflections</p>
            </div>

            <div id="diary-content">
                <!-- Top Bar: Login + New Entry Button -->
                <div style="max-width: 1200px; margin: 0 auto 60px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                    <!-- Login Form (compact) -->
                    <div id="login-section" style="flex: 0 0 auto;">
                        <form onsubmit="checkPassword(event)" style="display: flex; align-items: center; gap: 10px;">
                            <input 
                                type="password" 
                                id="diary-password" 
                                placeholder="Password"
                                style="padding: 10px 15px; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text); font-family: 'Space Mono', monospace; font-size: 0.9em; width: 160px;"
                            />
                            <button type="submit" class="btn btn-secondary" style="padding: 10px 20px; font-size: 0.85em;">Unlock</button>
                        </form>
                        <p id="error-msg" style="color: #ff6b6b; font-size: 0.75em; margin-top: 5px; display: none;">Incorrect password</p>
                    </div>

                    <!-- New Entry Button -->
                    <div id="new-entry-section" style="display: none;">
                        <button onclick="toggleNewEntryForm()" id="toggle-form-btn" class="btn btn-primary" style="padding: 10px 24px; font-size: 0.9em;">+ New Entry</button>
                    </div>
                </div>

                <!-- New Entry Form -->
                <div id="new-entry-form-container" style="max-width: 800px; margin: 0 auto 40px;">
                    <div id="new-entry-form" class="glass" style="display: none; padding: 40px;">
                        <h3 style="font-family: 'Press Start 2P', cursive; font-size: 1em; color: var(--accent); margin-bottom: 30px;">Create New Entry</h3>
                        <form onsubmit="addEntry(event)" style="display: flex; flex-direction: column; gap: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--accent);">Title</label>
                                <input 
                                    type="text" 
                                    id="entry-title" 
                                    required
                                    placeholder="Entry title..."
                                    style="width: 100%; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text); font-family: 'Space Mono', monospace; font-size: 1em;"
                                />
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--accent);">Content</label>
                                <textarea 
                                    id="entry-content" 
                                    rows="10" 
                                    required
                                    placeholder="Write your thoughts..."
                                    style="width: 100%; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text); font-family: 'Space Mono', monospace; font-size: 1em; line-height: 1.8; resize: vertical;"
                                ></textarea>
                            </div>
                            <div>
                                <label style="display: flex; align-items: center; gap: 10px; color: var(--text); cursor: pointer;">
                                    <input type="checkbox" id="entry-private" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span>Make this entry private</span>
                                </label>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary">Save Entry</button>
                                <button type="button" onclick="toggleNewEntryForm()" class="btn btn-secondary">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Entries Container (always visible) -->
                <div id="entries-container" style="max-width: 1200px; margin: 0 auto;"></div>

                <div style="text-align: center; padding: 60px 20px; color: var(--text-muted); font-style: italic;">
                    End of entries
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <p>Â© 2025 Aditya Dwi Nugroho</p>
        </div>
    </footer>

    <script>
        // Authentication state
        let isAuthenticated = sessionStorage.getItem('diaryAuth') === 'true';

        // Load entries on page load
        window.addEventListener('load', () => {
            loadEntries();
            if (isAuthenticated) {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('new-entry-section').style.display = 'block';
            }
        });

        async function checkPassword(e) {
            e.preventDefault();
            const input = document.getElementById('diary-password');
            const error = document.getElementById('error-msg');
            const button = e.target.querySelector('button');
            
            button.disabled = true;
            button.textContent = 'Checking...';
            
            try {
                const response = await fetch('/api/diary-auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: input.value })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    isAuthenticated = true;
                    sessionStorage.setItem('diaryAuth', 'true');
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('new-entry-section').style.display = 'block';
                    error.style.display = 'none';
                    loadEntries(); // Reload to show uncensored content
                } else {
                    error.style.display = 'block';
                    input.value = '';
                    input.focus();
                }
            } catch (err) {
                error.textContent = 'Connection error';
                error.style.display = 'block';
            }
            
            button.disabled = false;
            button.textContent = 'Unlock Private Entries';
        }

        function toggleNewEntryForm() {
            const form = document.getElementById('new-entry-form');
            const btn = document.getElementById('toggle-form-btn');
            if (form.style.display === 'none') {
                form.style.display = 'block';
                btn.textContent = 'Cancel';
                document.getElementById('entry-title').focus();
            } else {
                form.style.display = 'none';
                btn.textContent = '+ New Entry';
                document.getElementById('entry-title').value = '';
                document.getElementById('entry-content').value = '';
                document.getElementById('entry-private').checked = false;
            }
        }

        async function addEntry(e) {
            e.preventDefault();
            const title = document.getElementById('entry-title').value;
            const content = document.getElementById('entry-content').value;
            const isPrivate = document.getElementById('entry-private').checked;
            const button = e.target.querySelector('button[type="submit"]');
            
            button.disabled = true;
            button.textContent = 'Saving...';
            
            try {
                const response = await fetch('/api/diary-entries', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer true'
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        isPrivate: isPrivate
                    })
                });
                
                if (response.ok) {
                    // Clear form
                    document.getElementById('entry-title').value = '';
                    document.getElementById('entry-content').value = '';
                    document.getElementById('entry-private').checked = false;
                    toggleNewEntryForm();
                    
                    // Reload entries from server
                    await loadEntries();
                } else {
                    alert('Failed to save entry. Please try again.');
                }
            } catch (err) {
                console.error('Error saving entry:', err);
                alert('Connection error. Please try again.');
            }
            
            button.disabled = false;
            button.textContent = 'Save Entry';
            
            toggleNewEntryForm();
            loadEntries();
        }

        async function loadEntries() {
            const container = document.getElementById('entries-container');
            
            try {
                const headers = {};
                if (isAuthenticated) {
                    headers['Authorization'] = 'Bearer ' + sessionStorage.getItem('diaryAuth');
                }

                const response = await fetch('/api/diary-entries', { headers });
                let entries = await response.json();
                
                // Merge with localStorage entries
                const localEntries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
                entries = [...localEntries, ...entries];
                
                // Sort by date (newest first)
                entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                container.innerHTML = entries.map(entry => {
                    const date = new Date(entry.date);
                    const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const formattedTime = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                    const isPrivate = entry.isPrivate;
                    const isCensored = isPrivate && !isAuthenticated;
                    const entryNum = String(entry.id).padStart(3, '0');
                    
                    return `
                        <article class="glass" style="margin-bottom: 40px; padding: 40px; ${isCensored ? 'opacity: 0.7; border: 1px solid var(--accent);' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="font-family: 'Press Start 2P', cursive; font-size: 0.7em; color: var(--accent); margin-bottom: 10px;">
                                        Entry ${entryNum} ${isPrivate ? '[Private]' : ''}
                                    </div>
                                    <h3 style="font-size: 1.5em; color: var(--text);">${entry.title}</h3>
                                </div>
                                <div style="color: var(--text-muted); font-size: 0.9em; text-align: right;">
                                    <div>${formattedDate}</div>
                                    <div style="font-size: 0.85em; margin-top: 5px;">${formattedTime}</div>
                                </div>
                            </div>
                            <div style="color: var(--text-muted); line-height: 1.8; font-size: 1em;">
                                ${isCensored 
                                    ? `<p style="font-style: italic; text-align: center; padding: 40px 20px; color: var(--accent);">${entry.content}</p>
                                       <div style="text-align: center; margin-top: 20px;">
                                         <button onclick="document.getElementById('diary-password').focus()" 
                                                 class="btn btn-secondary" style="padding: 10px 20px; font-size: 0.85em;">
                                           Login to unlock
                                         </button>
                                       </div>`
                                    : entry.content.split('\n\n').map(p => `<p style="margin-bottom: 15px;">${p}</p>`).join('')
                                }
                            </div>
                        </article>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading entries:', error);
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">Failed to load entries. Try refreshing.</p>';
            }
        }

        // Custom Cursor
        const cursorDot = document.querySelector('.cursor-dot');
        const cursorRing = document.querySelector('.cursor-ring');
        
        let mouseX = 0, mouseY = 0;
        let ringX = 0, ringY = 0;
        
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            cursorDot.style.left = mouseX + 'px';
            cursorDot.style.top = mouseY + 'px';
        });
        
        function animateRing() {
            ringX += (mouseX - ringX) * 0.15;
            ringY += (mouseY - ringY) * 0.15;
            cursorRing.style.left = ringX + 'px';
            cursorRing.style.top = ringY + 'px';
            requestAnimationFrame(animateRing);
        }
        animateRing();
        
        const hoverElements = document.querySelectorAll('a, button, .btn, input');
        hoverElements.forEach(el => {
            el.addEventListener('mouseenter', () => {
                cursorRing.style.width = '60px';
                cursorRing.style.height = '60px';
                cursorRing.style.borderColor = 'var(--primary)';
                cursorDot.style.transform = 'translate(-50%, -50%) scale(1.5)';
            });
            
            el.addEventListener('mouseleave', () => {
                cursorRing.style.width = '40px';
                cursorRing.style.height = '40px';
                cursorRing.style.borderColor = 'var(--accent)';
                cursorDot.style.transform = 'translate(-50%, -50%) scale(1)';
            });
        });

        // Scroll progress
        window.addEventListener('scroll', () => {
            const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            document.querySelector('.scroll-progress').style.width = scrolled + '%';
        });
    </script>
</body>
</html>
